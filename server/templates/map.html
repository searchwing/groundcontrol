{% extends "base.html" %}
{% block head %}
<link rel="stylesheet" href="/static/openlayers/ol.css"/>
<script src="/static/jquery/jquery.js"></script>
<script src="/static/openlayers/ol.js"></script>
{% endblock %}
{% block title %}Map{% endblock %}
{% block content %}

<div id="map"></div>
<script>

var tilesLayer = new ol.layer.Tile({
    source: new ol.source.XYZ({
        url: "https://cartodb-basemaps-{a-c}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",
    })
});

var view = new ol.View({
    center : ol.proj.transform([13.41, 52.52], 'EPSG:4326', 'EPSG:3857'),
    minZoom:  3,
    maxZoom: 18,
    zoom   :  6, 
});

var position = new ol.Feature({});
position.setStyle(new ol.style.Style({
    image: new ol.style.Icon({
        src: "/static/plane.png",
    }),
}));
var features = [position,];
var vectorSource = new ol.source.Vector({features: features,});
var vectorLayer = new ol.layer.Vector({source: vectorSource,});

var map = new ol.Map({
    target : 'map',
    view   : view,
    layers : [
        tilesLayer,
        vectorLayer,
    ],
});

function update(){
    $.getJSON("/api/uav/position", function(data){
        var coord = ol.proj.transform(
            [data["lon"], data["lat"]], "EPSG:4326", "EPSG:3857");
        map.getView().setCenter(coord);
        position.setGeometry(new ol.geom.Point(coord));
        position.getStyle().getImage().setRotation(data["head"] * 0.01745329251);
    });
}
update();
setInterval(update, 1000);

</script>
{% endblock %}
